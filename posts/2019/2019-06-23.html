<!DOCTYPE html>
<html>
    <head>
        <title>夺回resolv.conf 的控制权 - fangpsh's blog</title>
        <meta charset="utf-8" />
        <link href="https://fangpsh.github.io/theme/static/css/bootstrap-3.0.0.min.css" rel="stylesheet" />
        <link href="https://fangpsh.github.io/theme/static/css/han.min.css" rel="stylesheet" /> 
        <link href="https://fangpsh.github.io/theme/static/css/style.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="https://fangpsh.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="fangpsh's blog Full Atom Feed" />
    </head>

    <body id="index" class="archive">
        <div class="container">
            <div class="header">
                <ul class="nav nav-pills pull-right">
                    <li class=""><a href="/">Home</a></li>
                    <li><a href="https://fangpsh.github.io/pages/about.html">About</a></li>
                    <li><a href="https://fangpsh.github.io/archives.html">Archives</a></li>
                </ul>
                <h3 class="text-muted"><a href="/">fangpsh's blog</a></h3>
				<h2 class="text-muted"></h2>
             </div>
<section id="content" class="article content">
  <header>
    <h2 class="entry-title">
      <a href="https://fangpsh.github.io/posts/2019/2019-06-23.html" rel="bookmark"
         title="Permalink to 夺回resolv.conf 的控制权">夺回resolv.conf 的控制权</a></h2>
 
  </header>
  
  <div id="toc">
  </div>     
  <div id="article-content" class="entry-content">
    <p>上周在线上修改了一批机器的hostname：</p>
<blockquote>
<p>hostnamectl set-hostname xxx</p>
</blockquote>
<p>后来有同学反馈2台机器的/etc/resolv.conf 被清空了，resolv.conf 的内容为：</p>
<div class="highlight"><pre><span></span><code># Generated by NetworkManager
</code></pre></div>

<p>完了，第一感觉是这两个事情一定有相关，我存在知识盲区，简单搜索，果然发现：  </p>
<p><a href="Bug 1344303 - hostnamectl set-hostname over-writes existing resolv.conf entries">Bug 1344303 - hostnamectl set-hostname over-writes existing resolv.conf entries</a>。</p>
<p>查看出问题的这2台机器的<code>/var/log/message</code> 也存在上述连接类似的日志：</p>
<div class="highlight"><pre><span></span><code><span class="n">Jun</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">48</span><span class="err">:</span><span class="mi">46</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">NetworkManager</span><span class="o">[</span><span class="n">605</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">info</span><span class="o">&gt;</span><span class="w">  </span><span class="n">Setting</span><span class="w"> </span><span class="k">system</span><span class="w"> </span><span class="n">hostname</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="w"> </span><span class="p">(</span><span class="k">from</span><span class="w"> </span><span class="k">system</span><span class="w"> </span><span class="n">configuration</span><span class="p">)</span>
<span class="n">Jun</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">48</span><span class="err">:</span><span class="mi">46</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">dbus</span><span class="o">[</span><span class="n">610</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">system</span><span class="o">]</span><span class="w"> </span><span class="n">Activating</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="nl">systemd</span><span class="p">:</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;org.freedesktop.nm_dispatcher&#39;</span><span class="w"> </span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;dbus-org.freedesktop.nm-dispatcher.service&#39;</span>
<span class="n">Jun</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">48</span><span class="err">:</span><span class="mi">46</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">dbus</span><span class="o">-</span><span class="n">daemon</span><span class="o">[</span><span class="n">610</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">dbus</span><span class="o">[</span><span class="n">610</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">system</span><span class="o">]</span><span class="w"> </span><span class="n">Activating</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="nl">systemd</span><span class="p">:</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;org.freedesktop.nm_dispatcher&#39;</span><span class="w"> </span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;dbus-org.freedesktop.nm-dispatcher.service&#39;</span>
<span class="n">Jun</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">48</span><span class="err">:</span><span class="mi">46</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">systemd</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="n">Manager</span><span class="w"> </span><span class="n">Script</span><span class="w"> </span><span class="n">Dispatcher</span><span class="w"> </span><span class="n">Service</span><span class="p">...</span>
<span class="n">Jun</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">48</span><span class="err">:</span><span class="mi">46</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">dbus</span><span class="o">[</span><span class="n">610</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">system</span><span class="o">]</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">activated</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="s1">&#39;org.freedesktop.nm_dispatcher&#39;</span>
<span class="n">Jun</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">48</span><span class="err">:</span><span class="mi">46</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">dbus</span><span class="o">-</span><span class="n">daemon</span><span class="o">[</span><span class="n">610</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">dbus</span><span class="o">[</span><span class="n">610</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">system</span><span class="o">]</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">activated</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="s1">&#39;org.freedesktop.nm_dispatcher&#39;</span>
<span class="n">Jun</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">48</span><span class="err">:</span><span class="mi">46</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">systemd</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">Started</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="n">Manager</span><span class="w"> </span><span class="n">Script</span><span class="w"> </span><span class="n">Dispatcher</span><span class="w"> </span><span class="n">Service</span><span class="p">.</span>
<span class="n">Jun</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">48</span><span class="err">:</span><span class="mi">46</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">nm</span><span class="o">-</span><span class="n">dispatcher</span><span class="o">[</span><span class="n">3006</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">Dispatching</span><span class="w"> </span><span class="k">action</span><span class="w"> </span><span class="s1">&#39;hostname&#39;</span>
</code></pre></div>

<p>Networkmanager 服务也确实在运行之中，存在相关日志：</p>
<div class="highlight"><pre><span></span><code><span class="n">settings</span><span class="o">:</span><span class="w"> </span><span class="n">hostname</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
</code></pre></div>

<p>不过很奇怪，当时总共修改了有几十台服务器，NetworkManager 在运行的也有几十台，其他的好像都没问题，后来为了复现，在这2台机器上再次手动修改hostname，复现不了。。orz，猜测可能和resolv.conf 原来的内容有关，细节可能需要读源码才知道。</p>
<h2>Bug 1344303</h2>
<p>话说回来，除了感觉自己存在知识盲区，“想当然”之外，这个Bug 实在是有点莫名其妙，就如同这个Bug 中的网友说的：</p>
<blockquote>
<p>My point is still, that hostnamectl does not look like you are editing resolv.conf. but I'm with you that there is a relation of the domain name and the FQDN. </p>
<p>I'll update NetworkManager.conf with main/dns=none - no problem. I just wished I knew earlier howto disable the management of resolv.conf</p>
</blockquote>
<p>然而作者的态度也是非常坚持，读起来有点爱用用，不用滚的味道。只能说我作为运维，对交付出来的机器，初始化不够统一，才会遇到这种坑。ok，在初始化脚本中增加（针对CentOS 7.x）：</p>
<div class="highlight"><pre><span></span><code>- name: Disable NetworkManager
  systemd:
    name: NetworkManager
    state: stopped
    enabled: false
  ignore_errors: true
</code></pre></div>

<p>网友指出:</p>
<blockquote>
<p>在 RHEL8 中，已经取消了 network.service，所有的网络配置都归属于 NetworkManager，这里可能不是很适用。</p>
</blockquote>
<p>具体可参考：<a href="https://zhuanlan.zhihu.com/p/56892392">基于RHEL8/CentOS8的网络IP配置详解</a>。</p>
<p>似乎Linux 的世界就是有这么多轮子，曾经想，Systemd 能一统天下，带来的却是更多轮子，23333。</p>
<h2>夺回控制权</h2>
<p>读到一篇文章：<a href="https://www.ctrl.blog/entry/resolvconf-tutorial.html">How to take back control of /etc/resolv.conf on Linux</a>，如何夺回Linux 上/etc/resolv.conf 的控制权！
原来还有这么多玩意，详情参考文章链接，作者一直在更新，很用心。</p>
<ul>
<li>NetworkManager</li>
<li>/etc/sysconfig/network/config: NETCONFIG_DNS_POLICY</li>
<li>resolvconf, rdnssd</li>
<li>systemd-resolved</li>
</ul>
<p>对了，<a href="https://www.cyberciti.biz/faq/dhclient-etcresolvconf-hooks/">DHCP 也可能会碰你的resolv.conf 哦</a>。</p>
<p>学无止境，坑外有坑。</p>
  </div><!-- /.entry-content -->
   <footer class="post-info text-muted">
    Posted on <abbr class="published" title="2019-06-23T00:00:00+08:00">
      Sun 23 June 2019
    </abbr>
    <address class="vcard author">
      by <a class="url fn" href="https://fangpsh.github.io/author/fangpsh.html">fangpsh</a>
    </address> in <a href="https://fangpsh.github.io/category/2019.html">2019</a> Tagged <a href="https://fangpsh.github.io/tag/linux.html">linux </a><a href="https://fangpsh.github.io/tag/resolvconf.html">resolv.conf </a>  </footer><!-- /.post-info -->
</section>
            <footer id="contentinfo" class="footer">
                    <nav class="pull-right bottom-nav">
                        <a href="https://fangpsh.github.io/feeds/all.atom.xml">RSS</a>
                    </nav>
                    <address id="about" class="vcard body">
                    &copy; <a href="https://fangpsh.github.io">fangpsh's blog</a> Proudly powered by <a href="http://getpelican.com/">Pelican</a>
                    </address><!-- /#about -->
            </footer><!-- /#contentinfo -->
        </div><!-- container -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-31894513-1");
pageTracker._trackPageview();
} catch(err) {}</script>
    <script src="https://fangpsh.github.io/theme/static/js/toc.js" type="text/javascript"></script>
    <script src="https://fangpsh.github.io/theme/static/js/han.min.js" type="text/javascript"></script>
    </body>
</html>