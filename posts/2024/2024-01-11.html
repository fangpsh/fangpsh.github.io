<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <title>ä¸ºä½•æ— æ³•æ€æ­»é˜¿é‡Œäº‘ç›¾ - fangpsh's blog</title>
        <meta charset="utf-8" />
        <meta name="google-site-verification" content="CbsgsM2tKx2Ho07c_HkPj2MvG1zaj2trcjW7Ed1pyMw" />
        <link href="https://fangpsh.github.io/theme/static/css/bootstrap-3.0.0.min.css" rel="stylesheet" />
        <link href="https://fangpsh.github.io/theme/static/css/han.min.css" rel="stylesheet" /> 
        <link href="https://fangpsh.github.io/theme/static/css/style.css" rel="stylesheet" />
        <link href="https://fangpsh.github.io/theme/static/css/code.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="fangpsh" />
<meta name="keywords" content="linux,sec" />
<meta name="description" content="è¾“é”™ PIDï¼Œç»™äº‘ç›¾è¿›ç¨‹å‘é€äº†kill signalï¼š root 26689 0.3 0.1 113180 9420 ? S&lt;sl 10:34 0:08 /usr/local/aegis/aegis_client/aegis_11_83/AliYunDun ... # kill -9 26689 -bash: kill: (26689) - Operation not permitted å’¦ï¼Œæ€ä¹ˆå•¥ä¸æ­»ï¼Œæˆ‘æ˜¯ â€¦" />

        <link href="https://fangpsh.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="fangpsh's blog Full Atom Feed" />
    </head>

    <body id="index" class="archive">
        <div class="container">
            <div class="header">
                <ul class="nav nav-pills pull-right">
                    <li class=""><a href="/">Home</a></li>
                    <li><a href="https://fangpsh.github.io/pages/about.html">About</a></li>
                    <li><a href="https://fangpsh.github.io/archives.html">Archives</a></li>
                </ul>
                <h3 class="text-muted"><a href="/">fangpsh's blog</a></h3>
				<h2 class="text-muted"></h2>
             </div>
<section id="content" class="article content">
  <header>
    <h2 class="entry-title">
      <a href="https://fangpsh.github.io/posts/2024/2024-01-11.html" rel="bookmark"
         title="Permalink to ä¸ºä½•æ— æ³•æ€æ­»é˜¿é‡Œäº‘ç›¾">ä¸ºä½•æ— æ³•æ€æ­»é˜¿é‡Œäº‘ç›¾</a></h2>
 
  </header>
  
  <div id="toc">
  </div>     
  <div id="article-content" class="entry-content">
    <p>è¾“é”™ PIDï¼Œç»™äº‘ç›¾è¿›ç¨‹å‘é€äº†kill signalï¼š</p>
<div class="highlight"><pre><span></span><code>root     26689  0.3  0.1 113180  9420 ?        S&lt;sl 10:34   0:08 /usr/local/aegis/aegis_client/aegis_11_83/AliYunDun
...

# kill -9 26689
-bash: kill: (26689) - Operation not permitted
</code></pre></div>

<p>å’¦ï¼Œæ€ä¹ˆå•¥ä¸æ­»ï¼Œæˆ‘æ˜¯ root å‘€ã€‚å†å°è¯•ä¸‹<code>systemctl stop aegis</code>ï¼ŒçŠ¶æ€æ˜¯<code>inactive</code>äº†ï¼Œä½†æ˜¯è¿›ç¨‹è¿˜åœ¨ ğŸ‘»ã€‚</p>
<div class="highlight"><pre><span></span><code>â— aegis.service - Aegis Service
   Loaded: loaded (/etc/systemd/system/aegis.service; enabled; vendor preset: disabled)
   Active: inactive (dead) since Wed 2024-01-10 14:46:43 HKT; 24h ago
   CGroup: /system.slice/aegis.service
           â”œâ”€26627 /usr/local/aegis/aegis_update/AliYunDunUpdate
           â”œâ”€26689 /usr/local/aegis/aegis_client/aegis_11_83/AliYunDun
           â””â”€26700 /usr/local/aegis/aegis_client/aegis_11_83/AliYunDunMonitor
</code></pre></div>

<p>å¥½å¥‡å¿ƒæ¥äº†ï¼Œå’‹å®ç°çš„å‘¢ï¼ŸğŸ˜¯</p>
<p>strace ä¸€ä¸‹ <code>strace kill -9 26689</code> æ²¡ä»€ä¹ˆæ”¶è·ï¼Œ</p>
<div class="highlight"><pre><span></span><code>open(&quot;/usr/lib/locale/UTF-8/LC_CTYPE&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
kill(26689, SIGKILL)                    = -1 EPERM (Operation not permitted)
write(2, &quot;kill: &quot;, 6kill: )                   = 6
write(2, &quot;sending signal to 26689 failed&quot;, 30sending signal to 26689 failed) = 30
write(2, &quot;: &quot;, 2: )                       = 2
write(2, &quot;Operation not permitted\n&quot;, 24Operation not permitted
) = 24
</code></pre></div>

<p>äº‘ç›¾çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿåˆ ä¸æ‰ï¼š</p>
<div class="highlight"><pre><span></span><code># rm -f /usr/local/aegis/aegis_client/aegis_11_81/AliYunDun
rm: cannot remove &#39;AliYunDun&#39;: Operation not permitted
</code></pre></div>

<p>ä¹Ÿå¯¹ï¼Œè¿™æ˜¯ä¸ªå®‰å…¨è½¯ä»¶ï¼ˆHIDSï¼‰ï¼Œè¦æ˜¯èƒ½è¿™ä¹ˆç®€å•è¢«å¹²æ‰ï¼Œä¹Ÿå¤ªå¼±äº†ã€‚
æƒ³èµ·æœ‰ç½‘å‹ä»‹æ„è¿™ç±»ç¨‹åºçš„ï¼Œé‚£æˆ‘çœ‹å¤§å®¶çš„å¸è½½æ¸…ç†æŒ‡å—ä¸å°±å¯ä»¥äº†ï¼Ÿ</p>
<p>æ‰¾åˆ°å¸è½½è„šæœ¬ï¼š</p>
<div class="highlight"><pre><span></span><code>http://update.aegis.aliyun.com/download/uninstall.sh
</code></pre></div>

<p><code>stop_aegis_pkill()</code> å°±æ˜¯æ™®é€šçš„ kill å‘ä¸ªä¿¡å·ï¼Œä¸è¿‡æ¥ç€æ‰§è¡Œçš„<code>wait_aegis_exit()</code> é‡Œé¢çš„è¯­å¥ï¼š</p>
<div class="highlight"><pre><span></span><code>    echo &quot;wait AliYunDun process exit fail, possibly due to self-protection, please uninstall aegis or disable self-protection from the aegis console.&quot;
</code></pre></div>

<p>æ„æ€å°±æ˜¯åœ¨æ§åˆ¶å°å…³é—­æ‰å°±å¯ä»¥è¢« kill äº†ï¼Œé‚£è¿™åº”è¯¥æ˜¯äº‘ç›¾è¿›ç¨‹è‡ªå·±æ§åˆ¶çš„ã€‚
å†å¾€ä¸‹çœ‹å¦‚ä½•æ¸…ç†æ–‡ä»¶ï¼Œçœ‹åˆ°äº†kprobeï¼š</p>
<div class="highlight"><pre><span></span><code>    kprobeArr=(
        &quot;/sys/kernel/debug/tracing/instances/aegis_do_sys_open/set_event&quot;
        &quot;/sys/kernel/debug/tracing/instances/aegis_inet_csk_accept/set_event&quot;
        &quot;/sys/kernel/debug/tracing/instances/aegis_tcp_connect/set_event&quot;
        &quot;/sys/kernel/debug/tracing/instances/aegis/set_event&quot;
        &quot;/sys/kernel/debug/tracing/instances/aegis_/set_event&quot;
        &quot;/sys/kernel/debug/tracing/instances/aegis_accept/set_event&quot;
        &quot;/sys/kernel/debug/tracing/kprobe_events&quot;
        &quot;/usr/local/aegis/aegis_debug/tracing/set_event&quot;
        &quot;/usr/local/aegis/aegis_debug/tracing/kprobe_events&quot;
    )
</code></pre></div>

<p>çœ‹ç€çœ¼ç†Ÿï¼Œä¹‹å‰çœ‹åŠ¨æ€è°ƒè¯•ç›¸å…³çš„æ–‡ç« è§è¿‡ï¼Œæ²¡æ·±å…¥äº†è§£å¿˜è®°äº†ï¼ŒåŸæ¥å¦‚æ­¤ã€‚</p>
<div class="highlight"><pre><span></span><code># lsmod  |grep -i ali
AliSecGuard            22400  2
</code></pre></div>

<p>æœç„¶æœ‰ä¸€ä¸ªé…å¥—çš„å†…æ ¸æ¨¡å—ã€‚</p>
<p>æ£€æŸ¥ä¸€ä¸‹eventï¼š</p>
<div class="highlight"><pre><span></span><code># trace-cmd list   |grep -i aegis
kprobes:aegis_cn_netlink_send
kprobes:aegis_sys_execve
kprobes:aegis_proc_fork_connector
</code></pre></div>

<p><a href="https://fast.v2ex.com/t/869181">v2exè¿™ä¸ªå¸–å­</a>ä¸­ï¼Œç½‘å‹æåˆ°äº†ç”¨kprobe æ£€æµ‹ç³»ç»Ÿè°ƒç”¨æ˜¯HIDS çš„ä¸»æµå®ç°æ–¹å¼ï¼Œæ˜¯æˆ‘èœé¸¡äº†ã€‚</p>
<p>æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£æ‰¾ä¸€ä¸ªå¼€æºçš„ HIDS å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<p>çœ‹åˆ°äº†å­—èŠ‚å¼€æºçš„ï¼š<a href="https://github.com/bytedance/Elkeid">elkeid</a>ï¼Œçœ‹è¿™ä¸ª<a href="https://mp.weixin.qq.com/s/rm_hXHb_YBWQqmifgAqfaw">åŸç†ä»‹ç»</a>ï¼š</p>
<blockquote>
<p>AgentSmithæ˜¯LKMï¼ˆå¯åŠ è½½å†…æ ¸æ¨¡å—ï¼‰çš„æ–¹å¼hookä½Linuxå†…æ ¸ä¸€äº›å‡½æ•°ã€‚ç”±äºå®ƒæ˜¯ä½¿ç”¨kprobeçš„æ–¹å¼ï¼Œå®ƒhookçš„å‡½æ•°ä¸åªæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè¿˜å¯ä»¥hookå†…æ ¸å†…éƒ¨ä¸€äº›å‡½æ•°ï¼Œè€Œè¿™äº›å†…éƒ¨å‡½æ•°æ˜¯æŸäº›ç³»ç»Ÿè°ƒç”¨çš„å…³é”®ç‚¹è°ƒç”¨ã€‚</p>
<p>kill
å¯¹kill/tkillç³»ç»Ÿè°ƒç”¨æŒ‚é’©ï¼Œè®°å½•ç¨‹åºç»ˆæ­¢æŸä¸ªè¿›ç¨‹æ“ä½œï¼Œ
è®°å½•ä¿¡æ¯ï¼š
æ‰§è¡Œç¨‹åº
ç›®æ ‡è¿›ç¨‹
ä¿¡å·</p>
</blockquote>
<p>å…ˆçœ‹è¿™ç¯‡æ–‡ç« å­¦ä¹ äº†ä¸‹æ€ä¹ˆå†™ä¸€ä¸ªç®€å•çš„ kprobe ä¾‹å­ï¼Œä»¥ä¾¿èƒ½ç•¥å¾®çœ‹æ‡‚ä»£ç ï¼š<br>
<a href="https://blog.csdn.net/luckyapple1028/article/details/52972315">ã€ŠLinuxå†…æ ¸è°ƒè¯•æŠ€æœ¯â€”â€”kprobeä½¿ç”¨ä¸å®ç°ã€‹</a>ã€‚</p>
<p>ç¿»äº†ä¸‹<code>Elkeid/driver/LKM/src/</code>  æ‰¾åˆ°äº† <a href="https://github.com/bytedance/Elkeid/blob/93a44936de68f351d967a66deca574fa0f8ea091/driver/LKM/src/smith_hook.c#L3895,L3903">kill_kprobe</a>ï¼š</p>
<div class="highlight"><pre><span></span><code>struct kprobe kill_kprobe = {
        .symbol_name = P_GET_SYSCALL_NAME(kill),
        .pre_handler = kill_pre_handler,
};

struct kprobe tkill_kprobe = {
        .symbol_name = P_GET_SYSCALL_NAME(tkill),
        .pre_handler = tkill_pre_handler,
};
</code></pre></div>

<p>å†é¡ºç€å°±å¯ä»¥æ‰¾åˆ°<code>register_kill_kprobe</code>ã€<code>kill_pre_handler()</code>  ç­‰ã€‚</p>
<p>å¤§æ¦‚æ˜ç™½äº†é€»è¾‘ï¼Œäº‘ç›¾æ˜¯hook äº† kill çš„ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨é‡Œé¢å®ç°äº†è‡ªä¿çš„é€»è¾‘ã€‚</p>
<p>ä¹Ÿå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç« <a href="https://www.gentoo.site/viewtopic.php?id=455">ã€Š linuxæºç è§£è¯»ï¼ˆåä¸‰ï¼‰ï¼šå†…æ ¸é©±åŠ¨moduleåŠ è½½kprobe&amp;å­—èŠ‚è·³åŠ¨Elkiedç®€è¦åˆ†æã€‹</a>ã€‚</p>
<p>è¿™ä¸¤ç¯‡è¯‘æ–‡å†™çš„ä¹Ÿéå¸¸å¥½ï¼Œå¯ä»¥è¡¥å……ä¸‹ ftrace çš„æŠ€èƒ½ï¼š</p>
<ul>
<li><a href="https://linux.cn/article-13752-1.html">ã€Šé€šè¿‡ ftrace æ¥åˆ†æ Linux å†…æ ¸ã€‹</a></li>
<li><a href="https://linux.cn/article-13852-1.html">ã€Šä½¿ç”¨ trace-cmd è¿½è¸ªå†…æ ¸ã€‹</a></li>
<li>GUI å·¥å…·ï¼š<a href="https://github.com/cunctator/traceshark">traceshark</a></li>
</ul>
  </div><!-- /.entry-content -->
   <footer class="post-info text-muted">
    Posted on <abbr class="published" title="2024-01-11T00:00:00+08:00">
      Thu 11 January 2024
    </abbr>
    <address class="vcard author">
      by <a class="url fn" href="https://fangpsh.github.io/author/fangpsh.html">fangpsh</a>
    </address> in <a href="https://fangpsh.github.io/category/2024.html">2024</a> Tagged <a href="https://fangpsh.github.io/tag/linux.html">linux </a><a href="https://fangpsh.github.io/tag/sec.html">sec </a>
  </footer>
<!-- /.post-info -->
</section>
    <script src="https://fangpsh.github.io/theme/static/js/toc.js" type="text/javascript"></script>
            <footer id="contentinfo" class="footer">
                    <nav class="pull-right bottom-nav">
                        <a href="https://fangpsh.github.io/feeds/all.atom.xml">RSS</a>
                    </nav>
                    <address id="about" class="vcard body">
                    &copy; <a href="https://fangpsh.github.io">fangpsh's blog</a> Proudly powered by <a href="http://getpelican.com/">Pelican</a>
                    </address><!-- /#about -->
            </footer><!-- /#contentinfo -->
        </div><!-- container -->
    <script src="https://fangpsh.github.io/theme/static/js/han.min.js" type="text/javascript"></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5X2BSH52P0');
    </script>

    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
            })(window, document, "clarity", "script", "jt8984mtdg");
    </script>
    </body>
</html>