<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <title>Authentik 集成华为云认证登录 - fangpsh's blog</title>
        <meta charset="utf-8" />
        <meta name="google-site-verification" content="CbsgsM2tKx2Ho07c_HkPj2MvG1zaj2trcjW7Ed1pyMw" />
        <link href="https://fangpsh.github.io/theme/static/css/bootstrap-3.0.0.min.css" rel="stylesheet" />
        <link href="https://fangpsh.github.io/theme/static/css/han.min.css" rel="stylesheet" /> 
        <link href="https://fangpsh.github.io/theme/static/css/style.css" rel="stylesheet" />
        <link href="https://fangpsh.github.io/theme/static/css/code.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="fangpsh" />
<meta name="keywords" content="authentik" />
<meta name="description" content="把几个云都对接完了，需要为华为云单独写一篇文章，因为它不太一样，“遥遥领先”。 第一个不同点，华为云没有角色的概念，需 …" />

        <link href="https://fangpsh.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="fangpsh's blog Full Atom Feed" />
    </head>

    <body id="index" class="archive">
        <div class="container">
            <div class="header">
                <ul class="nav nav-pills pull-right">
                    <li class=""><a href="/">Home</a></li>
                    <li><a href="https://fangpsh.github.io/pages/about.html">About</a></li>
                    <li><a href="https://fangpsh.github.io/archives.html">Archives</a></li>
                </ul>
                <h3 class="text-muted"><a href="/">fangpsh's blog</a></h3>
				<h2 class="text-muted"></h2>
             </div>
<section id="content" class="article content">
  <header>
    <h2 class="entry-title">
      <a href="https://fangpsh.github.io/posts/2025/2025-12-13.html" rel="bookmark"
         title="Permalink to Authentik 集成华为云认证登录">Authentik 集成华为云认证登录</a></h2>
 
  </header>
  
  <div id="toc">
  </div>     
  <div id="article-content" class="entry-content">
    <p>把几个云都对接完了，需要为华为云单独写一篇文章，因为它不太一样，“遥遥领先”。</p>
<p>第一个不同点，华为云没有角色的概念，需要配置一个身份转换规则，将SAML带过来的角色转换为华为云的用户组。<a href="https://support.huaweicloud.com/usermanual-iam/iam_08_0006.html">转换规则</a>看起来设计的很强大，实际没啥用，徒费心智。</p>
<p>如果有网友懒得看规则，可以直接抄这个：</p>
<div class="highlight"><pre><span></span><code>[
          {
                    &quot;remote&quot;: [
                              {
                                        &quot;type&quot;: &quot;http://schemas.goauthentik.io/2021/02/saml/username&quot;
                              },
                              {
                                        &quot;type&quot;: &quot;huaweiIAMGroupName&quot;
                              }
                    ],
                    &quot;local&quot;: [
                              {
                                        &quot;user&quot;: {
                                                  &quot;name&quot;: &quot;{0}&quot;
                                        }
                              },
                              {
                                        &quot;groups&quot;: &quot;{1}&quot;
                              }
                    ]
          }
]
</code></pre></div>

<p>type: http://schemas.goauthentik.io/2021/02/saml/username 可以改成你自定义的RoleSessionName Attribute Name。这就引出第二个不同点了。</p>
<p>第二个不同点，它没有类似其他云的显式RoleSessionName，需要你自定义，习惯一下。</p>
<p>第三个不同点，如果你的用户有多个角色，每个角色都不一样，华为云是将所有角色转换为组，然后将组权限做并集。是的，目前没法选择特定角色登录。几年前在用shibboleth做第一版IdP的时候反馈过，没理我。这次和售后拉研发上会反馈了，说会安排。但是后来又说不做了，给了一个<a href="https://support.huaweicloud.com/productdesc-identitycenter/iic_01_0002.html">新方案</a>，<a href="https://bbs.huaweicloud.com/blogs/429838">IAM身份中心如何对接Okta
</a>看得我头大，先不搞了。凑合用吧，有兴趣的网友可以试一试。估计现在维护的研发也是在维护历史项目，不想动💩⛰。</p>
<p>第四个不同点，从统一认证IAM发起登录，和从IdP发起登录会冲突。前者登录之后写入的cookies 会导致IdP发起的登录出错，服务端返回：</p>
<div class="highlight"><pre><span></span><code>The application has malfunctioned.
Please contact technical support to solve this issue.
Error code: E0019
Error message: No InResponseTo attribute in SAMLResponse, please troubleshoot on IdP side
</code></pre></div>

<p>也就是只能二选一，和售后反馈了说会修，今天问了下说发布遇到bug又回退了，不知道啥时候能修好。</p>
<p>第五个不同点，如果你在同个厂商有多个主体账号，在其他云可以传递多个arn拼凑起来，登录之后云厂商会列出多个主体账号下不同角色供你选择。华为云的huaweiIAMGroupName 属性和其他厂商的不一样，不携带account 信息，从<a href="https://bbs.huaweicloud.com/blogs/266721">这篇文章</a>里看到一个参数：<code>IAM_SAML_Attributes_identityProviders</code>，创建一个SAML Provider Property Mapping，可以达到类似效果，返回格式如下：</p>
<div class="highlight"><pre><span></span><code>return [ &quot;iam::{domain_id_1}:identityProvider:{idp_id_1}&quot;,
         &quot;iam::{domain_id_2}:identityProvider:{idp_id_2}&quot;,
         &quot;iam::{domain_id_3}:identityProvider:{idp_id_3}&quot;]
</code></pre></div>

<p>凑合用吧。</p>
  </div><!-- /.entry-content -->
   <footer class="post-info text-muted">
    Posted on <abbr class="published" title="2025-12-23T00:00:00+08:00">
      Tue 23 December 2025
    </abbr>
    <address class="vcard author">
      by <a class="url fn" href="https://fangpsh.github.io/author/fangpsh.html">fangpsh</a>
    </address> in <a href="https://fangpsh.github.io/category/2025.html">2025</a> Tagged <a href="https://fangpsh.github.io/tag/authentik.html">authentik </a>
  </footer>
<!-- /.post-info -->
</section>
    <script src="https://fangpsh.github.io/theme/static/js/toc.js" type="text/javascript"></script>
            <footer id="contentinfo" class="footer">
                    <nav class="pull-right bottom-nav">
                        <a href="https://fangpsh.github.io/feeds/all.atom.xml">RSS</a>
                    </nav>
                    <address id="about" class="vcard body">
                    &copy; <a href="https://fangpsh.github.io">fangpsh's blog</a> Proudly powered by <a href="http://getpelican.com/">Pelican</a>
                    </address><!-- /#about -->
            </footer><!-- /#contentinfo -->
        </div><!-- container -->
    <script src="https://fangpsh.github.io/theme/static/js/han.min.js" type="text/javascript"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5X2BSH52P0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5X2BSH52P0');
    </script>

    </body>
</html>