<!DOCTYPE html>
<html>
    <head>
        <title>è½»é‡çº§åŠå…¬å®¤æ— æ„ŸçŸ¥è·¨å¢ƒåŠ é€Ÿæ–¹æ¡ˆ - fangpsh's blog</title>
        <meta charset="utf-8" />
        <meta name="google-site-verification" content="CbsgsM2tKx2Ho07c_HkPj2MvG1zaj2trcjW7Ed1pyMw" />
        <link href="https://fangpsh.github.io/theme/static/css/bootstrap-3.0.0.min.css" rel="stylesheet" />
        <link href="https://fangpsh.github.io/theme/static/css/han.min.css" rel="stylesheet" /> 
        <link href="https://fangpsh.github.io/theme/static/css/style.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="https://fangpsh.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="fangpsh's blog Full Atom Feed" />
    </head>

    <body id="index" class="archive">
        <div class="container">
            <div class="header">
                <ul class="nav nav-pills pull-right">
                    <li class=""><a href="/">Home</a></li>
                    <li><a href="https://fangpsh.github.io/pages/about.html">About</a></li>
                    <li><a href="https://fangpsh.github.io/archives.html">Archives</a></li>
                </ul>
                <h3 class="text-muted"><a href="/">fangpsh's blog</a></h3>
				<h2 class="text-muted"></h2>
             </div>
<section id="content" class="article content">
  <header>
    <h2 class="entry-title">
      <a href="https://fangpsh.github.io/posts/2023/2023-04-23.html" rel="bookmark"
         title="Permalink to è½»é‡çº§åŠå…¬å®¤æ— æ„ŸçŸ¥è·¨å¢ƒåŠ é€Ÿæ–¹æ¡ˆ">è½»é‡çº§åŠå…¬å®¤æ— æ„ŸçŸ¥è·¨å¢ƒåŠ é€Ÿæ–¹æ¡ˆ</a></h2>
 
  </header>
  
  <div id="toc">
  </div>     
  <div id="article-content" class="entry-content">
    <p>ä¹‹å‰é€›V2EX çœ‹åˆ°ä¸€ä¸ªç½‘å‹çš„å¸–å­ï¼šâ€œ<a href="https://www.v2ex.com/t/928907">è¯·æ•™å…¬å¸å†…éƒ¨å¦‚ä½•å®ç°æ— æ„ŸçŸ¥è·¨å¢ƒåŠ é€Ÿ</a>â€ï¼ŒæŠŠæµ·å¤–IP å…¨éƒ¨èµ°åˆ°ä»£ç†ç½‘å…³ï¼Œç»´æŠ¤æˆæœ¬æ¯”è¾ƒé«˜ã€‚å¦‚æœåªæ˜¯ç®€å•çš„Web åŠ é€Ÿï¼ŒDNS åŠ«æŒ+SNIProxy æ˜¯æ›´è½»é‡çš„æ–¹æ³•ã€‚</p>
<p>~~æœ‰<a href="https://docs.fortinet.com/document/fortigate/6.2.14/cookbook/80739/dynamic-application-steering-with-lowest-cost-and-best-quality-strategies">Fortinet</a>ã€<a href="https://bbs.panabit.com/thread-12376-1-1.html">Panabit</a>çš„åœŸè±ªæ— é¡»æ¥ç€çœ‹ ğŸ¤‘~~</p>
<p>è¿™ä¸ªæ–¹æ¡ˆçš„å±€é™ï¼š</p>
<ol>
<li>åªèƒ½åŠ é€Ÿhttpã€https æµé‡ï¼›</li>
<li>github.comï¼ˆhttp2ï¼‰ä¼¼ä¹æœ‰å¼‚å¸¸ï¼Œè§ä¸‹æ–‡è§£å†³æ–¹æ³•ã€‚</li>
</ol>
<p>æŒ‰ç½‘å‹è¯´çš„è”é€š/ç”µä¿¡çš„MPLSï¼Œ1000å…ƒ/M/(æœˆ?)ï¼Œå¦‚æœæ˜¯æˆ‘çš„è¯ï¼Œå°±ä¼šæå‡ ä¸ªæœºåœºè´¦å·ï¼Œä¸€ä¸ªæœˆæˆæœ¬ç™¾æ¥å—è§£å†³ã€‚  </p>
<p>å½“ç„¶æˆ‘ç‰¢è®°å‰è¾ˆä»¬çš„è¡€æ³ªæ•™è®­ï¼šåœ¨å·¥ä½œåœºåˆä¸­ï¼Œèƒ½ç”¨é’±è§£å†³çš„ï¼Œå°½é‡ç”¨é’±ï¼ˆä¹™æ–¹ï¼‰è§£å†³ï¼Œè¦ä¸ç„¶å°±æ˜¯ç»™è‡ªå·±æ‰¾äº‹äº†ğŸ•ã€‚  </p>
<p>è¯´å›æ­£äº‹ï¼Œç”»ä¸ªè‰å›¾ï¼š</p>
<div class="highlight"><pre><span></span><code>             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   query:www.google.com â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º           â”‚
             â”‚  client  â”‚                        â”‚ local dns â”‚
             â”‚          â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
             â””â”€â”€â”€â”¬â”€â”€â”€â–²â”€â”€â”˜    A:192.168.11.11     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚   â”‚
                 â”‚   â”‚
                 â”‚   â”‚
         http reqâ”‚   â”‚ http rsp
                 â”‚   â”‚                      â”¼
                 â”‚   â”‚
                 â”‚   â”‚
             â”Œâ”€â”€â”€â–¼â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                  â”‚
             â”‚    proxy         â”‚
             â”‚  192.168.11.11   â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                             â”‚
                             â”‚internal
                             â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                          â”‚
       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
       â”‚ â”‚ SNIPROXY  â”‚  OUTPUT â”‚            â”‚     â”‚
       â”‚ â”‚ http:80   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   CLASH    â”‚     â”‚
       â”‚ â”‚ https:443 â”‚ IPTABLESâ”‚   TPROXY   â”‚     â”‚
       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
       â”‚                                          â”‚
       â”‚                                          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>æ‰¾ä¸€å°æœºå™¨è£…ä¸Šclash/v2ray/sing-box ç­‰ï¼Œä¸‹é¢ä»¥clashä¸ºä¾‹ã€‚</p>
<p>local dns ç”¨adguard-homeã€bindã€dnsmasqã€pdns-recursoréƒ½å¯ï¼ŒæŠŠè¦åŠ é€Ÿçš„å­åŸŸååŠ«æŒè§£æåˆ°ä»£ç†æœºIPã€‚</p>
<h2>SNIProxy é…ç½®</h2>
<p>ä»<a href="https://github.com/dlundquist/sniproxy">å®˜æ–¹ä»“åº“</a>æ‹‰ä»£ç ç¼–è¯‘å®‰è£…ï¼Œæˆ–è€…å‘è¡Œç‰ˆä»“åº“å†…æ‰¾æ‰¾ã€‚é…ç½®å°±ä¸€å¥è¯ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå¦‚æœä¸æƒ³æœ‰äººéšæ„æœ¬åœ°host ä¸‹åŸŸåå°±èƒ½èµ°è¿™ä¸ªä»£ç†ä¼ é€å‡ºå»ï¼Œå°±å†™ä¸‹å…·ä½“åŸŸåï¼Œè¯­æ³•å®˜æ–¹æ‰‹å†Œã€‚å½“ç„¶ä¹Ÿå¯ä»¥åœ¨clash é‚£é‡Œæ§åˆ¶ã€‚</p>
<div class="highlight"><pre><span></span><code>table http_hosts {
    .* *:80
}

table https_hosts {
    .* *:443
}
</code></pre></div>

<h2>Clash é…ç½®</h2>
<p>å°±ä¸€å¥è¯ï¼Œå…¶ä»–å’Œæ—¥å¸¸é…ç½®æ²¡å·®åˆ«ï¼š</p>
<div class="highlight"><pre><span></span><code>tproxy-port: 7891
</code></pre></div>

<p>è‹¥ç”¨éç‰¹æƒç”¨æˆ·èµ·ï¼Œclash.serviceè®°å¾—è®¾ç½®Capabilityã€‚</p>
<div class="highlight"><pre><span></span><code>CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_SYS_PTRACE CAP_DAC_READ_SEARCH
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_SYS_PTRACE CAP_DAC_READ_SEARCH
</code></pre></div>

<p>å¦å¤–åœ¨éƒ¨ç½²æ­¤ç±»ä»£ç†æ—¶ï¼Œå»ºè®®æ‹’ç»æ‰å†…ç½‘åŸŸåï¼ˆå†…ç½‘åœ°å€ï¼‰ï¼Œä»¥å…å¢åŠ è¿½è¸ªå®¡è®¡å¤æ‚åº¦ã€‚</p>
<div class="highlight"><pre><span></span><code>- GEOIP,LAN,REJECT
- DOMAIN-SUFFIX,oa.com,REJECT
- ...
</code></pre></div>

<h2>ä¸»æœºé…ç½®</h2>
<p>ä¸»è¦æ¶‰åŠç­–ç•¥è·¯ç”±å’Œiptablesï¼Œæ­£å¸¸åªéœ€è¦è®¾ç½®OUTPUT chain å³å¯ï¼Œä½†æ˜¯ä¸ºäº†è§£å†³ä¸‹æ–‡githubçš„é—®é¢˜ï¼Œä¹Ÿé…ç½®ä¸‹FORWARDã€‚</p>
<p>è®©ç‰¹æ®Šæ ‡è®°çš„åŒ…æµå‘æœ¬æœºï¼š</p>
<div class="highlight"><pre><span></span><code># è®°å¾—é…ç½®å¼€å¯å¯åŠ¨ç”Ÿæ•ˆ
ip route flush table 100
ip route add local default dev lo table 100
ip rule add fwmark 1 table 100
</code></pre></div>

<p>iptablesï¼ŒæŠ„ç½‘å‹çš„ï¼Œè®°å¾—åšæŒä¹…åŒ–ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">F</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">X</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">nat</span><span class="w"> </span><span class="o">-</span><span class="nv">F</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">F</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">P</span><span class="w"> </span><span class="nv">INPUT</span><span class="w"> </span><span class="nv">ACCEPT</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">P</span><span class="w"> </span><span class="nv">FORWARD</span><span class="w"> </span><span class="nv">ACCEPT</span>

<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">INPUT</span><span class="w"> </span><span class="o">-</span><span class="nv">m</span><span class="w"> </span><span class="nv">conntrack</span><span class="w"> </span><span class="o">--</span><span class="nv">ctstate</span><span class="w"> </span><span class="nv">ESTABLISHED</span>,<span class="nv">RELATED</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">ACCEPT</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">INPUT</span><span class="w"> </span><span class="o">-</span><span class="nv">p</span><span class="w"> </span><span class="nv">tcp</span><span class="w"> </span><span class="o">--</span><span class="nv">dport</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">ACCEPT</span>

<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">INPUT</span><span class="w"> </span><span class="o">-</span><span class="nv">s</span><span class="w"> </span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">ACCEPT</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">INPUT</span><span class="w"> </span><span class="o">-</span><span class="nv">s</span><span class="w"> </span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="nv">p</span><span class="w"> </span><span class="nv">tcp</span><span class="w">  </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">ACCEPT</span>

#<span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="nv">LOCAL</span><span class="w"> </span><span class="nv">AND</span><span class="w"> </span><span class="nv">LANS</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">8</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">8</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">8</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">169</span>.<span class="mi">254</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">172</span>.<span class="mi">16</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">12</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">192</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">192</span>.<span class="mi">0</span>.<span class="mi">2</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">198</span>.<span class="mi">18</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">15</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">198</span>.<span class="mi">51</span>.<span class="mi">100</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">203</span>.<span class="mi">0</span>.<span class="mi">113</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">255</span><span class="o">/</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">100</span>.<span class="mi">64</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">224</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">4</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">DROP</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">240</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">4</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
#<span class="w"> </span><span class="nv">FORWARD</span><span class="w"> </span><span class="nv">ALL</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">p</span><span class="w"> </span><span class="nv">udp</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">TPROXY</span><span class="w"> </span><span class="o">--</span><span class="nv">on</span><span class="o">-</span><span class="nv">port</span><span class="w"> </span><span class="mi">7891</span><span class="w"> </span><span class="o">--</span><span class="nv">tproxy</span><span class="o">-</span><span class="nv">mark</span><span class="w"> </span><span class="mi">1</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">clash</span><span class="w"> </span><span class="o">-</span><span class="nv">p</span><span class="w"> </span><span class="nv">tcp</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">TPROXY</span><span class="w"> </span><span class="o">--</span><span class="nv">on</span><span class="o">-</span><span class="nv">port</span><span class="w"> </span><span class="mi">7891</span><span class="w"> </span><span class="o">--</span><span class="nv">tproxy</span><span class="o">-</span><span class="nv">mark</span><span class="w"> </span><span class="mi">1</span>

#<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">OUTPUT</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">clash</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">PREROUTING</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">clash</span>


<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">N</span><span class="w"> </span><span class="nv">LOCAL_DIVERT</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">LOCAL_DIVERT</span><span class="w"> </span><span class="o">-</span><span class="nv">d</span><span class="w"> </span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="k">RETURN</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">LOCAL_DIVERT</span><span class="w"> </span><span class="o">-</span><span class="nv">p</span><span class="w"> </span><span class="nv">tcp</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">MARK</span><span class="w"> </span><span class="o">--</span><span class="nv">set</span><span class="o">-</span><span class="nv">mark</span><span class="w"> </span><span class="mi">1</span>
<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">LOCAL_DIVERT</span><span class="w"> </span><span class="o">-</span><span class="nv">p</span><span class="w"> </span><span class="nv">udp</span><span class="w"> </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">MARK</span><span class="w"> </span><span class="o">--</span><span class="nv">set</span><span class="o">-</span><span class="nv">mark</span><span class="w"> </span><span class="mi">1</span>

<span class="nv">iptables</span><span class="w"> </span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="nv">mangle</span><span class="w"> </span><span class="o">-</span><span class="nv">A</span><span class="w"> </span><span class="nv">OUTPUT</span><span class="w"> </span><span class="o">-</span><span class="nv">m</span><span class="w"> </span><span class="nv">owner</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="o">--</span><span class="nv">gid</span><span class="o">-</span><span class="nv">owner</span><span class="w"> </span>{<span class="w"> </span>è¿è¡Œ<span class="nv">clash</span><span class="w"> </span>ç¨‹åºçš„<span class="nv">GID</span>}<span class="w">  </span><span class="o">-</span><span class="nv">j</span><span class="w"> </span><span class="nv">LOCAL_DIVERT</span>
</code></pre></div>

<p>å¦‚æœå°è¯•å†™ï¼š<code>iptables -t mangle -A OUTPUT -j clash</code> ä¼šå‡ºç°é”™è¯¯ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="n">iptables</span> <span class="n">v1</span><span class="p">.</span><span class="mf">8.7</span> <span class="p">(</span><span class="n">nf_tables</span><span class="p">):</span>  <span class="n">RULE_APPEND</span> <span class="n">failed</span> <span class="p">(</span><span class="n">Invalid</span> <span class="n">argument</span><span class="p">):</span> <span class="n">rule</span> <span class="n">in</span> <span class="n">chain</span> <span class="n">OUTPUT</span>
</code></pre></div>

<p>ç½‘å‹è§£é‡Šï¼š</p>
<blockquote>
<p>ç”±äº tproxy åªèƒ½å·¥ä½œåœ¨ PREROUTING é“¾ï¼Œä»æœ¬æœºå‘å‡ºå»çš„æ•°æ®åŒ…ä¼šç›´æ¥é€šè¿‡ OUTPUT é“¾å‡ºå»äº†ï¼Œæœ¬æœºæ•°æ®åŒ…æ²¡æœ‰æœºä¼šèµ°ä¸€ä¸‹ PREROUTING é“¾ã€‚ ä½œè€…ï¼šé›é’K https://www.bilibili.com/read/cv14088928/ å‡ºå¤„ï¼šbilibili</p>
</blockquote>
<p>sysctl å¼€å¯ipv4åŒ…è½¬å‘ï¼š</p>
<div class="highlight"><pre><span></span><code>echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward
#å»ºè®®é…ç½®/etc/sysctl.confä¸­ï¼Œå¼€æœºç”Ÿæ•ˆã€‚
</code></pre></div>

<h2>github.com çš„é—®é¢˜</h2>
<p>å¦‚æœæŠŠgithub.com åŠ«æŒåˆ°sniproxyï¼Œä¸ä¹…æµè§ˆå™¨å°±ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š</p>
<div class="highlight"><pre><span></span><code>Fastly error: unknown domain: github.com. Please check that this domain has been added to a service.
Details: cache-hkg17926-HKG
</code></pre></div>

<p>æœåˆ°çš„ä¸€äº›issueï¼š  </p>
<ul>
<li><a href="https://github.com/dlundquist/sniproxy/issues/178">http2 clients being proxied to wrong host. #178</a></li>
<li><a href="https://github.com/snail007/goproxy/issues/422">HTTPä»£ç†è®¿é—®Githubä¼šç»å¸¸å‡ºç° Fastly error: unknown domain: github.com. #422
</a></li>
<li><a href="https://github.com/dlundquist/sniproxy/issues/242#issuecomment-302831849">NIproxy doesn't support http2 or SPDY explicitly,</a></li>
</ul>
<p>çœ‹èµ·æ¥å’Œhttp2 é•¿è¿æ¥æœ‰å…³ï¼Œæš‚æ—¶æ²¡ç²¾åŠ›ï¼ˆèƒ½åŠ›ï¼‰ç»†ç©¶ï¼Œçœ‹åˆ°æœ‰ä¸€ä¸ª<a href="https://github.com/dlundquist/sniproxy/pull/98">PR</a>æ˜¯èƒ½é’ˆå¯¹ç‰¹å®šåŸŸåæŒ‡å®šä¸€äº›ï¼Œä½†æ˜¯æ²¡åˆã€‚</p>
<p>é‚£å°±åªèƒ½å€’å›å»ç”¨ç½‘å…³çš„æ¨¡å¼è§£å†³äº†ã€‚</p>
<p>dig äº†ä¸‹github.com çš„åŸŸåï¼Œé›†ä¸­åœ¨è¿™2ä¸ªæ®µï¼Œæ·»åŠ ç­–ç•¥è·¯ç”±ï¼ŒæŠŠä¸‹ä¸€æ¡æŒ‡åˆ°ä»£ç†æœºã€‚</p>
<div class="highlight"><pre><span></span><code><span class="mf">140.82.112.0</span><span class="o">/</span><span class="mf">22</span>
<span class="mf">20.205.192.0</span><span class="o">/</span><span class="mf">18</span>
</code></pre></div>

<p>å†…ç½‘æ­å»ºä¸€ä¸ªuptime kuma æˆ–è€…megaease/easeprobeï¼Œå¯¹github.com è¿›è¡Œcurl æ¢æµ‹ï¼Œå‘ç°å¼‚å¸¸å†åŠ æ–°çš„IPã€‚</p>
<h2>sniproxy+v2ray+redirect</h2>
<p>v2rayï¼ˆdokodemo-doorï¼‰+ redirect ä¹Ÿè¡Œï¼Œç®€å•è´´ä¸‹é…ç½®ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;log&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;loglevel&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;warning&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;access&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/log/v2ray/access.log&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/log/v2ray/error.log&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s2">&quot;inbounds&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;tag&quot;</span><span class="p">:</span><span class="s2">&quot;transparent&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;port&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">12345</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dokodemo-door&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;network&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tcp,udp&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;followRedirect&quot;</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;sniffing&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;destOverride&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;http&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;tls&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;streamSettings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;sockopt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="s2">&quot;tproxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;redirect&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="s2">&quot;outbounds&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;vmess&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">...</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;streamSettings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;sockopt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;mark&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;tag&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;proxy&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

iptables<span class="w"> </span>-F
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-F
iptables<span class="w"> </span>-P<span class="w"> </span>INPUT<span class="w"> </span>ACCEPT
iptables<span class="w"> </span>-P<span class="w"> </span>FORWARD<span class="w"> </span>ACCEPT


iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-N<span class="w"> </span>V2RAY
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>V2RAY

iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>V2RAY<span class="w"> </span>-d<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-j<span class="w"> </span>RETURN
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>V2RAY<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.0.0.0/8<span class="w"> </span>-j<span class="w"> </span>RETURN
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>V2RAY<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>RETURN<span class="w"> </span>-m<span class="w"> </span>mark<span class="w"> </span>--mark<span class="w"> </span>0xff
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>V2RAY<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>REDIRECT<span class="w"> </span>--to-ports<span class="w"> </span><span class="m">12345</span>

iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>V2RAY
</code></pre></div>

<h2>å®¹ç¾</h2>
<p>è¿™äº›ç½‘ç«™æœ¬æ¥å°±ä¸å­˜åœ¨ï¼Œå®¹ä»€ä¹ˆç¾ï¼ŸğŸ˜‚</p>
<ul>
<li><a href="http://www.linuxvirtualserver.org/">LVS</a> ä¼ ç»Ÿåšæ³•<ul>
<li>æˆ–è€…åœŸè±ªæœ‰F5ä¹‹ç±»</li>
</ul>
</li>
<li>é…ç½®å¤šä¸ªä»£ç†æœºï¼Œlocal dns é‚£é‡Œè¿”å›å¤šä¸ªAè®°å½•ï¼ŒChrome è‡ªå·±ä¼šé‡è¯•ï¼›<ul>
<li>æˆ‘é€‰è¿™ä¸ª</li>
</ul>
</li>
</ul>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ul>
<li><a href="https://guide.v2fly.org/app/tproxy.html#%E8%AE%BE%E7%BD%AE%E7%BD%91%E5%85%B3">é€æ˜ä»£ç†(TPROXY)</a></li>
<li><a href="https://www.bilibili.com/read/cv14088928/">ä½¿ç”¨ iptables çš„ tproxy å®Œæˆæœ¬æœºè®¿é—®å®¶é‡Œå†…ç½‘</a></li>
<li><a href="https://moecm.com/something-about-v2ray-with-tproxy/">ç¬¬ä¸€ç¯‡ä¸‡å­—é•¿æ–‡ï¼šå›´ç»•é€æ˜ä»£ç†çš„åˆä¸€æ¬¡æ¢ç©¶</a></li>
<li><a href="https://blog.mmf.moe/post/tproxy-investigation/">TProxy æ¢ç§˜</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/networking/tproxy.txt">tproxy.txt</a></li>
</ul>
  </div><!-- /.entry-content -->
   <footer class="post-info text-muted">
    Posted on <abbr class="published" title="2023-04-23T00:00:00+08:00">
      Sun 23 April 2023
    </abbr>
    <address class="vcard author">
      by <a class="url fn" href="https://fangpsh.github.io/author/fangpsh.html">fangpsh</a>
    </address> in <a href="https://fangpsh.github.io/category/2023.html">2023</a> Tagged <a href="https://fangpsh.github.io/tag/proxy.html">proxy </a><a href="https://fangpsh.github.io/tag/iptables.html">iptables </a>
   <!--    -->

  </footer><!-- /.post-info -->
</section>
            <footer id="contentinfo" class="footer">
                    <nav class="pull-right bottom-nav">
                        <a href="https://fangpsh.github.io/feeds/all.atom.xml">RSS</a>
                    </nav>
                    <address id="about" class="vcard body">
                    &copy; <a href="https://fangpsh.github.io">fangpsh's blog</a> Proudly powered by <a href="http://getpelican.com/">Pelican</a>
                    </address><!-- /#about -->
            </footer><!-- /#contentinfo -->
        </div><!-- container -->
    <script src="https://fangpsh.github.io/theme/static/js/toc.js" type="text/javascript"></script>
    <script src="https://fangpsh.github.io/theme/static/js/han.min.js" type="text/javascript"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5X2BSH52P0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5X2BSH52P0');
    </script>
    </body>
</html>